{% load static %}
<!DOCTYPE html>
<html class="light" lang="fr">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Calendrier - Hub Étudiant UBO</title>
<script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
<link href="https://fonts.googleapis.com" rel="preconnect"/>
<link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css2?family=Lexend:wght@100..900&display=swap" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>
<script>
tailwind.config = {
    darkMode: "class", 
    theme: {
        extend: {
            colors: {
                primary: "#F4C753", 
                "background-light": "#f8f7f6", 
                "background-dark": "#221d10",
                "surface-light": "#ffffff",
                "surface-dark": "#1e2025",
                "border-light": "#e5e7eb",
                "border-dark": "#374151"
            }, 
            fontFamily: {display: "Lexend"}, 
            borderRadius: {DEFAULT: "0.25rem", lg: "0.5rem", xl: "0.75rem", full: "9999px"}
        }
    }
};
</script>
<style>
 .material-symbols-outlined { font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24; font-size: 24px; }
 .calendar-grid { display: grid; grid-template-rows: repeat({{ hours|length }}, 100px); grid-gap: 0; position: relative; padding: 0 0 100px 0; }
 .event-item { position: absolute; width: calc(100% - 8px); padding: 8px; z-index: 10; }
</style>
</head>
<body class="font-display bg-background-light dark:bg-background-dark text-gray-900 dark:text-white">
<div class="flex h-screen w-full overflow-hidden">
    
    <aside class="flex w-64 flex-col justify-between bg-surface-light dark:bg-surface-dark p-4 border-r border-border-light dark:border-border-dark flex-shrink-0 h-full overflow-y-auto">
        <div class="flex flex-col gap-6">
            <div class="flex items-center gap-3 px-3">
                <img src="{% static 'images/images.png' %}" alt="Logo UBO" class="size-10 rounded-full"/>
                <div class="flex flex-col">
                    <h1 class="text-base font-bold leading-normal">UBO</h1>
                    <p class="text-gray-500 dark:text-gray-400 text-sm font-normal">Hub Étudiant</p>
                </div>
            </div>
            
            {% if user.full_name %}
            <div class="flex flex-col px-3 py-2">
                <p class="text-base font-semibold">{{ user.full_name }}</p>
                <p class="text-sm text-gray-500 dark:text-gray-400">{{ user.year }}</p>
            </div>
            {% endif %}

            <nav class="flex flex-col gap-2">
                <a class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-gray-100 dark:hover:bg-white/5 text-gray-700 dark:text-gray-300" href="{% url 'dashboard:dashboard' %}">
                    <span class="material-symbols-outlined">home</span>
                    <p class="text-sm font-medium">Accueil</p>
                </a>
                <a class="flex items-center gap-3 px-3 py-2 rounded-lg bg-primary/20 text-primary-700 dark:text-primary" href="{% url 'dashboard:calendar' %}">
                    <span class="material-symbols-outlined">calendar_month</span>
                    <p class="text-sm font-medium">Calendrier</p>
                </a>
                <a class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-gray-100 dark:hover:bg-white/5 text-gray-700 dark:text-gray-300" href="{% url 'dashboard:chat' %}">
                    <span class="material-symbols-outlined">mail</span>
                    <p class="text-sm font-medium">Messagerie</p>
                </a>
                <a class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-gray-100 dark:hover:bg-white/5 text-gray-700 dark:text-gray-300" href="{% url 'dashboard:forum' %}">
                    <span class="material-symbols-outlined">forum</span>
                    <p class="text-sm font-medium">Forum</p>
                </a>
                <a class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-gray-100 dark:hover:bg-white/5 text-gray-700 dark:text-gray-300" href="{% url 'dashboard:profile' %}">
                    <span class="material-symbols-outlined">account_circle</span>
                    <p class="text-sm font-medium">Mon Profil</p>
                </a>
                <button onclick="openCampusMap()" class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-gray-100 dark:hover:bg-white/5 text-gray-700 dark:text-gray-300 w-full text-left">
                    <span class="material-symbols-outlined">map</span>
                    <p class="text-sm font-medium">Plan du Campus</p>
                </button>
            </nav>
        </div>
        <div class="pt-4 border-t border-border-light dark:border-border-dark">
            <a class="flex items-center gap-3 px-3 py-2 rounded-lg text-red-500 hover:bg-red-50 dark:hover:bg-red-900/20" href="{% url 'dashboard:logout' %}">
                <span class="material-symbols-outlined">logout</span>
                <p class="text-sm font-medium">Déconnexion</p>
            </a>
        </div>
    </aside>

    <main class="flex-1 p-8 overflow-y-auto">
        <header class="flex justify-between items-center mb-8">
            <h1 class="text-3xl font-bold">Calendrier Académique</h1>
            <button onclick="openEventModal()" class="flex items-center gap-2 px-4 py-2 bg-primary text-gray-900 rounded-lg font-bold shadow hover:bg-primary/90 transition">
                <span class="material-symbols-outlined">add</span> Ajouter
            </button>
        </header>

        {% if success_message %}
        <div class="p-4 mb-6 bg-green-100 text-green-700 rounded-lg">{{ success_message }}</div>
        {% endif %}

        <div class="bg-surface-light dark:bg-surface-dark rounded-xl border border-border-light dark:border-border-dark overflow-hidden flex flex-col shadow-sm">
            <div class="flex items-center justify-between p-4 border-b border-border-light dark:border-border-dark">
                <div class="flex items-center gap-4">
                    <a href="?date={{ prev_week_date }}" class="p-2 hover:bg-gray-100 dark:hover:bg-white/5 rounded-lg"><span class="material-symbols-outlined">chevron_left</span></a>
                    <h2 class="text-lg font-bold">{{ current_week_label }}</h2>
                    <a href="?date={{ next_week_date }}" class="p-2 hover:bg-gray-100 dark:hover:bg-white/5 rounded-lg"><span class="material-symbols-outlined">chevron_right</span></a>
                </div>
                <a href="{% url 'dashboard:calendar' %}" class="px-4 py-1 border border-border-light dark:border-border-dark rounded hover:bg-gray-100 dark:hover:bg-white/5">Aujourd'hui</a>
            </div>

            <div class="flex overflow-x-auto">
                <div class="w-16 flex-shrink-0 border-r border-border-light dark:border-border-dark">
                    <div class="h-16"></div>
                    {% for hour in hours %}
                    <div class="h-[100px] border-b border-gray-100 dark:border-gray-800 text-right pr-2 text-xs text-gray-400 -mt-2">{{ hour }}:00</div>
                    {% endfor %}
                </div>

                {% for day in week_days %}
                <div class="flex-grow min-w-[150px] border-r border-border-light dark:border-border-dark last:border-r-0">
                    <div class="h-16 flex flex-col justify-center items-center border-b border-border-light dark:border-border-dark bg-gray-50 dark:bg-white/5">
                        <span class="font-bold">{{ day.day_name }}</span>
                        <span class="text-xs text-gray-500">{{ day.date|date:"d M" }}</span>
                    </div>
                    <div class="relative calendar-grid">
                        {% for hour in hours %}
                        <div class="border-b border-gray-100 dark:border-gray-800 h-[100px]"></div>
                        {% endfor %}

                        {% for event in day.events %}
                        <div class="event-item rounded p-2 text-xs border-l-4 bg-primary/10 border-primary"
                             style="top: {{ event.total_start_offset }}px; height: {{ event.height }}px;">
                            <p class="font-bold truncate">{{ event.display_name }}</p>
                            <p class="truncate">{{ event.location }}</p>
                            {% if event.is_personal_event %}
                            <form method="POST" action="{% url 'dashboard:delete_personal_event' eventId=event.id %}" class="absolute top-1 right-1">
                                {% csrf_token %}
                                <button type="submit" class="text-red-500 hover:text-red-700" onclick="return confirm('Supprimer ?')">
                                    <span class="material-symbols-outlined text-[16px]">delete</span>
                                </button>
                            </form>
                            {% endif %}
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </main>
</div>

<div id="event-modal" class="hidden fixed inset-0 z-50 bg-black/70 flex items-center justify-center p-4">
    <div class="bg-white dark:bg-surface-dark rounded-xl max-w-md w-full p-6 relative">
        <button onclick="closeEventModal()" class="absolute top-4 right-4"><span class="material-symbols-outlined">close</span></button>
        <h3 class="text-xl font-bold mb-4">Nouvel événement</h3>
        <form method="POST" action="{% url 'dashboard:calendar' %}" class="flex flex-col gap-4">
            {% csrf_token %}
            <input type="text" name="title" placeholder="Titre" required class="rounded border-gray-300 dark:bg-white/5 dark:border-gray-700">
            <input type="text" name="location" placeholder="Lieu" required class="rounded border-gray-300 dark:bg-white/5 dark:border-gray-700">
            <div class="grid grid-cols-2 gap-2">
                <input type="date" name="date" required value="{{ current_date }}" class="rounded border-gray-300 dark:bg-white/5 dark:border-gray-700">
                <div class="flex gap-1">
                    <input type="time" name="start_time" value="09:00" required class="w-full rounded border-gray-300 dark:bg-white/5 dark:border-gray-700">
                    <input type="time" name="end_time" value="10:00" required class="w-full rounded border-gray-300 dark:bg-white/5 dark:border-gray-700">
                </div>
            </div>
            <button type="submit" class="bg-primary text-gray-900 font-bold py-2 rounded">Créer</button>
        </form>
    </div>
</div>

<div id="campusMapModal" class="hidden fixed inset-0 z-50 bg-black/70 flex items-center justify-center p-4" onclick="closeCampusMap()">
    <div class="bg-white dark:bg-surface-dark rounded-xl max-w-4xl w-full p-4 relative" onclick="event.stopPropagation()">
        <img src="https://www.univ-brest.fr/faculte-medecine/sites/faculte-medecine.www.univ-brest.fr/files/2022-05/PLAN-CAMPUS-BREST-horizontal_amphis500-600.png" class="w-full rounded shadow">
    </div>
</div>

<script>
    function openEventModal() { document.getElementById('event-modal').classList.remove('hidden'); }
    function closeEventModal() { document.getElementById('event-modal').classList.add('hidden'); }
    function openCampusMap() { document.getElementById('campusMapModal').classList.remove('hidden'); }
    function closeCampusMap() { document.getElementById('campusMapModal').classList.add('hidden'); }
</script>
</body>
</html>