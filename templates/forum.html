{% load tz %}
{% load static %}
<!DOCTYPE html>
<html class="light" lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Forum - UBHome</title>
  <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
  <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@100..900&display=swap" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />
  <script>
    tailwind.config = {
      darkMode: "class",
      theme: {
        extend: {
          colors: {
            primary: "#F4C753",
            "background-light": "#f8f7f6",
            "background-dark": "#221d10",
            "surface-light": "#ffffff",
            "surface-dark": "#1e2025",
            "border-light": "#e5e7eb",
            "border-dark": "#374151",
            "ubo-blue": "#0055A4",
            "ubo-yellow": "#F4C753"
          },
          fontFamily: { display: "Lexend" },
          borderRadius: { DEFAULT: "0.25rem", lg: "0.5rem", xl: "0.75rem", full: "9999px" }
        }
      }
    };
  </script>
  <style>
    .material-symbols-outlined {
      font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
      font-size: 24px;
    }
  </style>
</head>
<body class="font-display bg-background-light dark:bg-background-dark text-gray-900 dark:text-white">
<div class="flex h-screen">
  
  <!-- Sidebar principale (identique aux autres pages) -->
  <aside class="flex h-screen min-h-[700px] w-64 flex-col justify-between bg-white dark:bg-slate-900 p-4 border-r border-slate-200 dark:border-slate-800 sticky top-0">
    <div class="flex flex-col gap-6">
      <div class="flex items-center gap-3 px-3">
        <img src="{% static 'images/images.png' %}" alt="Logo UBO" class="size-10 rounded-full"/>
        <div class="flex flex-col">
          <h1 class="text-[#111318] dark:text-white text-base font-bold leading-normal">UBO</h1>
          <p class="text-[#616f89] dark:text-slate-400 text-sm font-normal leading-normal">Hub √âtudiant</p>
        </div>
      </div>

      {% if user.full_name %}
      <div class="flex flex-col px-3 py-2">
        <p class="text-base font-semibold">{{ user.full_name }}</p>
        <p class="text-sm text-gray-500 dark:text-gray-400">{{ user.year }}</p>
      </div>
      {% endif %}

      <nav class="flex flex-col gap-2">
        <a class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-800"
           href="{% url 'dashboard:dashboard' %}">
          <span class="material-symbols-outlined text-[#111318] dark:text-slate-300">home</span>
          <p class="text-[#111318] dark:text-slate-300 text-sm font-medium leading-normal">Accueil</p>
        </a>

        <a class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-800"
           href="{% url 'dashboard:calendar' %}">
          <span class="material-symbols-outlined text-[#111318] dark:text-slate-300">calendar_month</span>
          <p class="text-[#111318] dark:text-slate-300 text-sm font-medium leading-normal">Calendrier</p>
        </a>

        <a class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-800"
           href="{% url 'dashboard:chat' %}">
          <span class="material-symbols-outlined text-[#111318] dark:text-slate-300">mail</span>
          <p class="text-[#111318] dark:text-slate-300 text-sm font-medium leading-normal">Emails</p>
        </a>

        <a class="flex items-center gap-3 px-3 py-2 rounded-lg bg-primary/10 dark:bg-primary/20"
           href="{% url 'dashboard:forum' %}">
          <span class="material-symbols-outlined text-primary dark:text-primary">forum</span>
          <p class="text-primary dark:text-primary text-sm font-medium leading-normal">Forum</p>
        </a>

        <button onclick="openCampusMap()" class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-800 text-left w-full">
          <span class="material-symbols-outlined text-[#111318] dark:text-slate-300">map</span>
          <p class="text-[#111318] dark:text-slate-300 text-sm font-medium leading-normal">Plan du Campus</p>
        </button>
      </nav>
    </div>

    <div class="flex flex-col gap-1">
      <a class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-800"
         href="{% url 'dashboard:profile' %}">
        <span class="material-symbols-outlined text-[#111318] dark:text-slate-300">account_circle</span>
        <p class="text-[#111318] dark:text-slate-300 text-sm font-medium leading-normal">Mon Profil</p>
      </a>
      <a class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-red-50 dark:hover:bg-red-900/20"
         href="{% url 'dashboard:logout' %}">
        <span class="material-symbols-outlined text-red-500">logout</span>
        <p class="text-red-500 text-sm font-medium leading-normal">D√©connexion</p>
      </a>
    </div>
  </aside>

  <!-- Sidebar secondaire pour les canaux -->
  <aside class="w-72 bg-background-light dark:bg-background-dark border-r border-border-light dark:border-border-dark flex flex-col">
    <div class="p-4 border-b border-border-light dark:border-border-dark">
      <h2 class="text-lg font-bold text-gray-900 dark:text-white flex items-center gap-2">
        <span class="material-symbols-outlined text-primary">tag</span>
        Canaux
      </h2>
      <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">S√©lectionnez un canal</p>
    </div>

    <div class="flex-1 overflow-y-auto p-2">
      <div class="space-y-2">
        {% for channel_data in all_channels %}
          <a href="?channel={{ channel_data.channel.name }}"
             class="block p-3 rounded-lg transition-all hover:shadow-md {% if channel_data.is_active %}bg-primary/20 border-2 border-primary shadow-sm{% else %}bg-white dark:bg-slate-800 border border-border-light dark:border-border-dark hover:border-primary/30{% endif %}">
            <div class="flex items-start justify-between gap-2">
              <div class="flex-1 min-w-0">
                <p class="font-semibold text-sm truncate {% if channel_data.is_active %}text-primary{% else %}text-gray-900 dark:text-white{% endif %}">
                  {{ channel_data.channel.name }}
                </p>
                <p class="text-xs text-gray-500 dark:text-gray-400 mt-0.5">
                  {{ channel_data.post_count }} message{{ channel_data.post_count|pluralize }}
                </p>
              </div>
              {% if channel_data.unread_count > 0 %}
                <span class="flex-shrink-0 bg-red-500 text-white text-xs font-bold rounded-full min-w-[20px] h-5 flex items-center justify-center px-1.5">
                  {{ channel_data.unread_count }}
                </span>
              {% endif %}
            </div>
          </a>
        {% endfor %}
      </div>
    </div>
  </aside>

  <!-- Zone principale des messages -->
  <main class="flex-1 flex flex-col bg-gradient-to-b from-slate-50 to-white dark:from-slate-900 dark:to-slate-800">
    <header class="border-b border-border-light dark:border-border-dark bg-white dark:bg-slate-900 px-6 py-4 shadow-sm">
      <div class="flex items-center gap-3">
        <div class="bg-primary/10 p-2 rounded-lg">
          <span class="material-symbols-outlined text-primary text-2xl">forum</span>
        </div>
        <div>
          <h1 class="text-xl font-bold text-gray-900 dark:text-white">{{ channel.name }}</h1>
          {% if channel.description %}
            <p class="text-sm text-gray-500 dark:text-gray-400">{{ channel.description }}</p>
          {% endif %}
        </div>
      </div>
    </header>

    <section class="flex-1 overflow-y-auto p-6 space-y-4">
      {% if posts %}
        {% for post in posts %}
          <div class="max-w-2xl {% if post.author.student_id == user.student_id %}ml-auto{% endif %}">
            <div class="flex items-start gap-3 {% if post.author.student_id == user.student_id %}flex-row-reverse{% endif %}">
              <div class="flex-shrink-0">
                {% if post.author.profile_picture %}
                  <img src="{{ post.author.profile_picture.url }}" 
                       alt="{{ post.author.full_name }}" 
                       class="w-10 h-10 rounded-full object-cover shadow-md border-2 {% if post.author.student_id == user.student_id %}border-primary{% else %}border-gray-300 dark:border-gray-600{% endif %}">
                {% else %}
                  <img src="{% static 'images/images.png' %}" 
                       alt="UBO" 
                       class="w-10 h-10 rounded-full object-cover shadow-md border-2 {% if post.author.student_id == user.student_id %}border-primary{% else %}border-gray-300 dark:border-gray-600{% endif %}">
                {% endif %}
              </div>
              <div class="flex-1">
                <div class="flex items-baseline gap-2 mb-1 {% if post.author.student_id == user.student_id %}justify-end{% endif %}">
                  <p class="text-xs font-semibold {% if post.author.student_id == user.student_id %}text-primary{% else %}text-gray-700 dark:text-gray-300{% endif %}">
                    {% if post.author.student_id == user.student_id %}Vous{% else %}{{ post.author.full_name }}{% endif %}
                  </p>
                  <p class="text-xs text-gray-400">{{ post.posted_at|localtime|date:"d/m/Y H:i" }}</p>
                </div>
                <div class="{% if post.author.student_id == user.student_id %}bg-gradient-to-br from-primary to-ubo-yellow text-gray-900{% else %}bg-white dark:bg-slate-800 text-gray-800 dark:text-gray-200{% endif %} rounded-2xl px-4 py-3 shadow-md border {% if post.author.student_id == user.student_id %}border-primary/20{% else %}border-border-light dark:border-border-dark{% endif %}">
                  {% if post.content %}
                    <p class="text-sm whitespace-pre-wrap leading-relaxed">{{ post.content }}</p>
                  {% endif %}
                  {% if post.attachments.all %}
                    <div class="space-y-2 mt-3 pt-3 border-t {% if post.author.student_id == user.student_id %}border-gray-900/10{% else %}border-gray-200 dark:border-gray-700{% endif %}">
                      {% for attachment in post.attachments.all %}
                        <a href="{{ attachment.file.url }}" download
                           class="flex items-center gap-2 p-2 rounded-lg {% if post.author.student_id == user.student_id %}bg-white/20 hover:bg-white/30{% else %}bg-slate-50 dark:bg-slate-700 hover:bg-slate-100 dark:hover:bg-slate-600{% endif %} transition-colors group">
                          <span class="material-symbols-outlined text-base {% if post.author.student_id == user.student_id %}text-gray-900{% else %}text-ubo-blue{% endif %}">description</span>
                          <span class="text-xs font-medium truncate flex-1">{{ attachment.original_name|default:attachment.file.name }}</span>
                          <span class="material-symbols-outlined text-sm opacity-0 group-hover:opacity-100 transition-opacity">download</span>
                        </a>
                      {% endfor %}
                    </div>
                  {% endif %}
                </div>
              </div>
            </div>
          </div>
        {% endfor %}
      {% else %}
        <div class="flex flex-col items-center justify-center py-20 text-gray-400">
          <span class="material-symbols-outlined text-6xl mb-4 opacity-30">chat_bubble_outline</span>
          <p class="text-sm">Aucun message pour le moment.</p>
          <p class="text-xs mt-1">Soyez le premier √† √©crire !</p>
        </div>
      {% endif %}
    </section>

    <footer class="border-t border-border-light dark:border-border-dark bg-white dark:bg-slate-900 p-4 shadow-lg">
      <form method="post" enctype="multipart/form-data" class="space-y-3" id="forumMessageForm">
        {% csrf_token %}
        <div class="relative">
          <textarea name="content" rows="3" 
                    class="w-full border-2 border-border-light dark:border-border-dark rounded-xl px-4 py-3 text-sm bg-surface-light dark:bg-surface-dark text-gray-900 dark:text-white focus:ring-2 focus:ring-primary focus:border-primary transition-all resize-none" 
                    placeholder="üí¨ √âcrire un message..."></textarea>
        </div>
        
        <!-- Aper√ßu des fichiers s√©lectionn√©s -->
        <div id="filesPreviewContainer" class="hidden space-y-2">
          <p class="text-xs font-semibold text-gray-600 dark:text-gray-400 flex items-center gap-2">
            <span class="material-symbols-outlined text-sm">attach_file</span>
            Fichiers s√©lectionn√©s :
          </p>
          <div id="filesPreviewList" class="grid grid-cols-2 gap-2"></div>
        </div>

        <div class="flex items-center justify-between gap-3">
          <label class="relative cursor-pointer group">
            <input type="file" name="attachments" multiple accept="image/*,application/pdf,.doc,.docx,.txt,.zip" class="hidden" id="fileInput" />
            <div class="flex items-center gap-2 px-4 py-2 rounded-full bg-slate-100 dark:bg-slate-800 hover:bg-slate-200 dark:hover:bg-slate-700 transition-all group-hover:shadow-md border border-slate-300 dark:border-slate-600">
              <span class="material-symbols-outlined text-lg text-ubo-blue">attach_file</span>
              <span class="text-xs font-medium text-gray-700 dark:text-gray-300">Joindre des fichiers</span>
            </div>
          </label>
          <button type="submit" 
                  class="px-6 py-2.5 rounded-full bg-gradient-to-r from-ubo-blue to-primary hover:from-ubo-blue/90 hover:to-primary/90 text-white text-sm font-bold transition-all transform hover:scale-105 shadow-lg hover:shadow-xl flex items-center gap-2">
            <span class="material-symbols-outlined text-lg">send</span>
            Envoyer
          </button>
        </div>
      </form>
    </footer>
  </main>
</div>

<!-- Modal Plan Campus -->
<div id="campusMapModal" class="hidden fixed inset-0 z-50 bg-black/70 flex items-center justify-center p-4">
  <div class="bg-white dark:bg-slate-900 rounded-xl max-w-7xl w-full overflow-hidden shadow-2xl">
    <div class="flex items-center justify-between p-4 border-b border-border-light dark:border-border-dark">
      <h2 class="text-xl font-bold text-gray-900 dark:text-white flex items-center gap-2">
        <span class="material-symbols-outlined text-primary">map</span>
        Plan du Campus
      </h2>
      <button onclick="closeCampusMap()" class="p-2 hover:bg-gray-100 dark:hover:bg-white/10 rounded-lg">
        <span class="material-symbols-outlined text-gray-500">close</span>
      </button>
    </div>
    <div class="p-6 bg-slate-50 dark:bg-slate-800/50"></div>
      <img src="https://www.univ-brest.fr/faculte-medecine/sites/faculte-medecine.www.univ-brest.fr/files/2022-05/PLAN-CAMPUS-BREST-horizontal_amphis500-600.png"
           alt="Plan du Campus" class="w-full h-auto rounded-lg shadow-lg">
    </div>
  </div>
</div>

<script>
  function openCampusMap() { document.getElementById('campusMapModal').classList.remove('hidden'); }
  function closeCampusMap() { document.getElementById('campusMapModal').classList.add('hidden'); }

  // Gestion de l'envoi du message avec Entr√©e
  document.addEventListener('DOMContentLoaded', function() {
    const messageInput = document.querySelector('textarea[name="content"]');
    const forumForm = document.getElementById('forumMessageForm');
    const fileInput = document.getElementById('fileInput');
    const filesPreviewContainer = document.getElementById('filesPreviewContainer');
    const filesPreviewList = document.getElementById('filesPreviewList');

    // Gestion de l'aper√ßu des fichiers
    fileInput.addEventListener('change', function(e) {
      const files = Array.from(e.target.files);
      
      if (files.length === 0) {
        filesPreviewContainer.classList.add('hidden');
        filesPreviewList.innerHTML = '';
        return;
      }

      filesPreviewContainer.classList.remove('hidden');
      filesPreviewList.innerHTML = '';

      files.forEach((file, index) => {
        const fileItem = document.createElement('div');
        fileItem.className = 'relative group bg-slate-50 dark:bg-slate-800 border-2 border-slate-200 dark:border-slate-700 rounded-lg p-3 hover:border-primary/50 transition-all';
        
        const isImage = file.type.startsWith('image/');
        
        if (isImage) {
          // Aper√ßu image
          const reader = new FileReader();
          reader.onload = function(e) {
            fileItem.innerHTML = `
              <div class="relative">
                <img src="${e.target.result}" alt="${file.name}" class="w-full h-24 object-cover rounded-lg mb-2">
                <button type="button" onclick="removeFile(${index})" class="absolute -top-2 -right-2 bg-red-500 text-white rounded-full p-1 opacity-0 group-hover:opacity-100 transition-opacity shadow-lg">
                  <span class="material-symbols-outlined text-sm">close</span>
                </button>
              </div>
              <p class="text-xs text-gray-700 dark:text-gray-300 truncate font-medium">${file.name}</p>
              <p class="text-xs text-gray-500">${formatFileSize(file.size)}</p>
            `;
          };
          reader.readAsDataURL(file);
        } else {
          // Aper√ßu fichier non-image
          const fileIcon = getFileIcon(file.type, file.name);
          fileItem.innerHTML = `
            <div class="flex items-center gap-3">
              <div class="flex-shrink-0 w-12 h-12 rounded-lg bg-gradient-to-br from-ubo-blue to-primary flex items-center justify-center">
                <span class="material-symbols-outlined text-white">${fileIcon}</span>
              </div>
              <div class="flex-1 min-w-0">
                <p class="text-xs text-gray-700 dark:text-gray-300 truncate font-medium">${file.name}</p>
                <p class="text-xs text-gray-500">${formatFileSize(file.size)}</p>
              </div>
              <button type="button" onclick="removeFile(${index})" class="flex-shrink-0 bg-red-500 text-white rounded-full p-1 opacity-0 group-hover:opacity-100 transition-opacity">
                <span class="material-symbols-outlined text-sm">close</span>
              </button>
            </div>
          `;
        }
        
        filesPreviewList.appendChild(fileItem);
      });
    });

    // Fonction pour retirer un fichier
    window.removeFile = function(index) {
      const dt = new DataTransfer();
      const files = Array.from(fileInput.files);
      
      files.forEach((file, i) => {
        if (i !== index) {
          dt.items.add(file);
        }
      });
      
      fileInput.files = dt.files;
      fileInput.dispatchEvent(new Event('change'));
    };

    // Fonction pour formater la taille du fichier
    function formatFileSize(bytes) {
      if (bytes === 0) return '0 B';
      const k = 1024;
      const sizes = ['B', 'KB', 'MB', 'GB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
    }

    // Fonction pour obtenir l'ic√¥ne selon le type de fichier
    function getFileIcon(type, name) {
      if (type.includes('pdf')) return 'picture_as_pdf';
      if (type.includes('word') || name.endsWith('.doc') || name.endsWith('.docx')) return 'description';
      if (type.includes('sheet') || name.endsWith('.xls') || name.endsWith('.xlsx')) return 'table_chart';
      if (type.includes('zip') || type.includes('compressed')) return 'folder_zip';
      if (type.includes('text')) return 'article';
      return 'insert_drive_file';
    }

    // Gestion du clavier
    messageInput.addEventListener('keydown', function(e) {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        const content = messageInput.value.trim();
        const hasFiles = fileInput.files.length > 0;
        
        if (content.length > 0 || hasFiles) {
          forumForm.submit();
        }
      }
    });
  });
</script>

</body>
</html>